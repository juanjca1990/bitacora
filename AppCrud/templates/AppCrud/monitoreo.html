{% extends "AppCrud/padre.html" %}
{% block title %}Monitoreo{% endblock %}
{% block bloque %}
<head>
    <title>Tabla de Estados</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
{% load custom_filters %}

<div class="container mt-4">
    <h1 style="text-align: center;">{{empresa}}</h1>
    
    <form method="get" class="mb-3">
        <div class="form-group d-flex align-items-center">
            <label for="servidor_id" class="mr-2">Servidor:</label>
            <select name="servidor_id" id="servidor_id" class="form-control mr-2" onchange="this.form.submit()">
                {% for servidor in servidores %}
                    <option value="{{ servidor.id }}" {% if servidor.id == servidor_id %}selected{% endif %}>{{ servidor.nombre }}</option>
                {% endfor %}
            </select>
            <noscript><button type="submit" class="btn btn-primary">Ver</button></noscript>
        </div>
    </form>

    {% if registros_por_servidor %}
        <div class="leyenda-iconos">
            <div class="icono-item">‚úÖ Verificado correctamente</div>
            <div class="icono-item">üîò No verificado</div>
            <div class="icono-item">‚ùå Fallo en la verificaci√≥n</div>
            <div class="icono-item">‚ö†Ô∏è Verificaci√≥n pendiente</div>
            <div class="icono-item"><div class="cuadro-azul"></div> Se realiz√≥ un comentario</div>
        </div>

        
        <div class="nav-meses cabecera-tabla">
            <div class="nav-referencia-estados" style="margin-bottom: 10px;">
                
                <a href="{% url 'imprimirRegistroMes' mes_actual anio_actual empresa.id %}" class="btn-mes-navegacion btn-icon-only" style="margin-left: 10px;" title="Imprimir Fallos">
                    <i class="fas fa-download" style="color: #ffffff; margin-right: 5px;"></i><i class="fa-regular fa-xmark" style="width: 5px; height: 5px; color: #ffffff;"></i>
                </a>
                
                <a href="{% url 'imprimirRegistroMesCompleto' mes_actual anio_actual empresa.id %}" class="btn-mes-navegacion btn-icon-only" style="margin-left: 10px;" title="Imprimir Completo">
                    <i class="fas fa-download" style="color: #ffffff;margin-right: 5px;"></i><i class="fa-regular fa-plus" style="width: 5px; height: 5px; color: #ffffff;"></i>
                </a>

                {% if user.is_staff or user.is_superuser %}
                    <a href="{% url 'habilitar_deshabilitar_edicion' %}?fecha={{ fecha_actual|date:'Y-m-d' }}{% if servidor_id %}&servidor_id={{ servidor_id }}{% endif %}" class="btn-mes-navegacion btn-icon-only" style="margin-left: 10px;" title="Habilitar/Deshabilitar edici√≥n" onclick="guardarPosicionScroll()">
                        <i class="fas fa-edit" style="color: #ffffff;"></i>
                    </a>
                {% endif %}

                <!-- Bot√≥n de actualizar a d√≠a actual -->
                <a href="{% url 'monitoreo' fecha_hoy|date:'Y-m-d' %}?vista=semana{% if servidor_id %}&servidor_id={{ servidor_id }}{% endif %}" class="btn-mes-navegacion btn-icon-only" style="margin-left: 10px;" title="Ir al d√≠a actual" onclick="guardarPosicionScroll()">
                    <i class="fas fa-sync-alt" style="color: #ffffff;"></i>
                </a>
            </div>
            
            <!-- Navegaci√≥n de meses -->
            <div class="nav-meses-adicional">
                <a href="{% url 'cambiarMesMonitor' %}?mes={{ mes_anterior }}&anio={{ anio_anterior }}{% if servidor_id %}&servidor_id={{ servidor_id }}{% endif %}" class="btn btn-mes-navegacion" onclick="guardarPosicionScroll()">‚Üê Mes Anterior</a>
                <span style="margin: 0 15px;"><b>{{ mes_nombre }} {{ anio_actual }}</b></span>
                <a href="{% url 'cambiarMesMonitor' %}?mes={{ mes_siguiente }}&anio={{ anio_siguiente }}{% if servidor_id %}&servidor_id={{ servidor_id }}{% endif %}" class="btn btn-mes-navegacion" onclick="guardarPosicionScroll()">Mes Siguiente ‚Üí</a>
            </div>
        </div>
        {% for servidor_obj, tabla_datos in registros_por_servidor.items %}
            <div class="cabecera-tabla">
                <h2>Servidor: {{ servidor_obj.nombre }}</h2>
                <!-- Navegaci√≥n de semanas -->
                <div class="nav-semanas" style="margin-bottom: 15px;">
                    <a href="{% url 'cambiarSemanaMonitor' %}?fecha={{ fecha_actual|date:'Y-m-d' }}&direccion=anterior{% if servidor_id %}&servidor_id={{ servidor_id }}{% endif %}" class="btn btn-mes-navegacion" onclick="guardarPosicionScroll()">‚Üê Semana Anterior</a>
                    <span style="margin: 0 15px;"><b>{{ inicio_semana|date:'d/m/Y' }}-{{ fin_semana|date:'d/m/Y' }}</b></span>
                    <a href="{% url 'cambiarSemanaMonitor' %}?fecha={{ fecha_actual|date:'Y-m-d' }}&direccion=siguiente{% if servidor_id %}&servidor_id={{ servidor_id }}{% endif %}" class="btn btn-mes-navegacion" onclick="guardarPosicionScroll()">Semana Siguiente ‚Üí</a>
                </div>
            </div>
            {% if tabla_datos %}
                <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th class="nombre-descripcion"></th>
                            {% for dia in dias_semana %}
                                <th>{{ dia }}</th>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th class="nombre-descripcion">Transacciones</th>
                            {% for dia in dias_periodo %}
                                <th>{{ dia.day }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for fila in tabla_datos %}
                        <tr>
                            <td class="nombre-descripcion"><p>{{ fila.registro.nombre }}</p><p>{{ fila.registro.descripcion }}</p></td>
                            {% for estado in fila.estados %}
                            <td>
                                {% with dia_actual=dias_periodo|index:forloop.counter0 %}
                                    {% if dia_actual.weekday == 5 or dia_actual.weekday == 6 %}
                                        <!-- S√°bado o domingo: celda vac√≠a -->
                                    {% elif dias_no_modificables|index:forloop.counter0 or not usuario_puede_editar %}
                                        <div class="icon-container dia-no-modificable" style="font-weight:bold; font-size:16px; cursor:not-allowed;">
                                            <i class="fas
                                                {% if estado %}
                                                    {% if estado.tipo_verificacion == 'bien' %}fa-check-circle
                                                    {% elif estado.tipo_verificacion == 'no_verificado' %}fa-circle
                                                    {% elif estado.tipo_verificacion == 'fallo' %}fa-times-circle
                                                    {% elif estado.tipo_verificacion == 'pendiente' %}fa-exclamation-circle
                                                    {% else %}fa-circle icono-vacio
                                                    {% endif %}
                                                {% else %}
                                                    fa-circle icono-vacio
                                                {% endif %}
                                            "></i>
                                        </div>
                                        <div>
                                            <button class="descripcion-btn {% if estado and estado.tiene_comentarios %}descripcion-btn-azul{% endif %} descripcion-btn-deshabilitado"
                                                data-tooltip="{% if estado.tiene_comentarios %}{{ estado.obtener_comentarios_formateados|escapejs }}{% else %}Sin comentarios{% endif %}"
                                                onmouseenter="mostrarTooltip(this)" onmouseleave="ocultarTooltip()">
                                                <i class="fas fa-comment"></i>
                                            </button>
                                        </div>
                                    {% else %}
                                        <div class="estado-container">
                                            <select class="estado-select" 
                                                    data-servidor-id="{{ servidor_obj.id }}"
                                                    data-empresa-id="{{ empresa.id }}"
                                                    data-registro-id="{{ fila.registro.id }}"
                                                    data-fecha="{{ dias_periodo|index:forloop.counter0 }}"
                                                    onchange="cambiarEstado(this)">
                                                <option value="no_verificado" {% if not estado or estado.tipo_verificacion == 'no_verificado' %}selected{% endif %}>
                                                    üîò no verificado
                                                </option>
                                                <option value="bien" {% if estado and estado.tipo_verificacion == 'bien' %}selected{% endif %}>
                                                    ‚úÖ bien
                                                </option>
                                                <option value="fallo" {% if estado and estado.tipo_verificacion == 'fallo' %}selected{% endif %}>
                                                    ‚ùå fallo
                                                </option>
                                                <option value="pendiente" {% if estado and estado.tipo_verificacion == 'pendiente' %}selected{% endif %}>
                                                    ‚ö†Ô∏è pendiente
                                                </option>
                                            </select>
                                        </div>
                                        <div>
                                            <button class="descripcion-btn {% if estado and estado.tiene_comentarios %}descripcion-btn-azul{% endif %}"
                                                data-registro-id="{{ fila.registro.id }}"
                                                data-fecha="{{ dias_periodo|index:forloop.counter0 }}"
                                                data-estado-id="{% if estado %}{{ estado.id }}{% else %}{% endif %}"
                                                data-servidor-id="{{ servidor_obj.id }}"
                                                data-empresa-id="{{ empresa.id }}"
                                                onclick="abrirModalFromButton(this)">
                                                <i class="fas fa-comment"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            {% else %}
                <p>No hay registros para este servidor.</p>
            {% endif %}
        {% endfor %}
{% else %}
    <p>No hay datos disponibles para mostrar.</p>
{% endif %}
<p></p>
<!-- Modal -->
<div id="modalDescripcion" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h3>Comentarios</h3>
        
        <!-- √Årea para mostrar comentarios existentes -->
        <div id="comentariosExistentes" style="background-color: #f9f9f9; border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; max-height: 200px; overflow-y: auto;">
            <h4 style="margin-top: 0;">Comentarios anteriores:</h4>
            <div id="listaComentarios" style="white-space: pre-line; font-family: monospace; font-size: 0.9em;">
                Cargando comentarios...
            </div>
        </div>
        
        <!-- Campo para nuevo comentario -->
        <label for="descripcionText"><strong>Agregar nuevo comentario:</strong></label>
        <textarea id="descripcionText" placeholder="Escriba un nuevo comentario..." style="margin-top: 5px;"></textarea>
        
        <div style="margin-top: 15px;">
            <button class="submit-btn" onclick="guardarDescripcion()">Agregar Comentario</button>
            <button class="btn btn-secondary" onclick="cerrarModal()" style="margin-left: 10px;">Cancelar</button>
        </div>
    </div>
</div>

<!-- Spinner de carga -->
<div id="loadingSpinner" class="loading-overlay" style="display: none;">
    <div class="spinner-container">
        <div class="spinner"></div>
        <p>Actualizando...</p>
    </div>
</div>

<!-- Tooltip para comentarios -->
<div id="comentario-tooltip" class="tooltip-comentario"></div>
<script>
    let modal = document.getElementById("modalDescripcion");
    let registroIdGlobal, fechaGlobal, estadoIdGlobal, servidorIdGlobal, empresaIdGlobal;

    function cambiarEstado(selectElement) {
        // Verificar si el usuario tiene permisos para editar
        {% if not usuario_puede_editar %}
            alert("No tiene permisos para modificar los estados.");
            selectElement.selectedIndex = selectElement.getAttribute('data-original-index') || 0;
            return;
        {% endif %}
        
        // Mostrar spinner de carga
        mostrarSpinner();
        
        // Guardar la posici√≥n de scroll antes de hacer la petici√≥n
        guardarPosicionScroll();
        
        let registroId = selectElement.getAttribute('data-registro-id');
        let fecha = selectElement.getAttribute('data-fecha');
        let nuevoValor = selectElement.value;
        let servidorId = selectElement.getAttribute('data-servidor-id');
        let empresaId = selectElement.getAttribute('data-empresa-id');
        
        let fechaObj = new Date(fecha);
        if (isNaN(fechaObj.getTime())) {
            fechaObj = new Date(parseInt(fecha));
        }
        let fechaFormateada = fechaObj.toISOString().split("T")[0];

        fetch("/AppCrud/registrarEstado/", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
            body: JSON.stringify({
                registro_id: registroId,
                fecha: fechaFormateada,
                tipo_verificacion: nuevoValor,
                servidor_id: servidorId,
                empresa_id: empresaId
            })
        }).then(response => response.json()).then(data => {
            if (!data.success) {
                ocultarSpinner();
                alert("Error al actualizar el estado.");
                // Revertir el cambio en caso de error
                selectElement.selectedIndex = selectElement.getAttribute('data-original-index') || 0;
            } else {
                // Actualizar el √≠ndice original para futuras reversiones
                selectElement.setAttribute('data-original-index', selectElement.selectedIndex);
                ocultarSpinner();
            }
        }).catch(error => {
            ocultarSpinner();
            alert("Error de conexi√≥n al actualizar el estado.");
            // Revertir el cambio en caso de error
            selectElement.selectedIndex = selectElement.getAttribute('data-original-index') || 0;
        });
    }

    function abrirModal(registroId, fecha, estadoId, descripcionActual = "", servidorId = null, empresaId = null) {
        {% if not usuario_puede_editar %}
            // Solo mostrar la descripci√≥n sin permitir edici√≥n
            alert("Comentarios: " + (descripcionActual || "No hay comentarios"));
            return;
        {% endif %}
        
        registroIdGlobal = registroId;
        fechaGlobal = fecha;
        estadoIdGlobal = estadoId;
        servidorIdGlobal = servidorId;
        empresaIdGlobal = empresaId;
        
        // Limpiar el campo de nuevo comentario
        document.getElementById("descripcionText").value = "";
        
        // Cargar comentarios existentes
        cargarComentariosExistentes();
        
        document.body.classList.add('modal-open');
        modal.style.display = "block";
    }

    function abrirModalFromButton(button) {
        {% if not usuario_puede_editar %}
            // Solo mostrar sin permitir edici√≥n
            alert("No tiene permisos para modificar comentarios");
            return;
        {% endif %}
        
        const registroId = button.getAttribute('data-registro-id');
        const fecha = button.getAttribute('data-fecha');
        const estadoId = button.getAttribute('data-estado-id');
        const servidorId = button.getAttribute('data-servidor-id');
        const empresaId = button.getAttribute('data-empresa-id');
        
        abrirModal(registroId, fecha, estadoId, "", servidorId, empresaId);
    }

    function cargarComentariosExistentes() {
        // Mostrar mensaje de carga
        document.getElementById("listaComentarios").textContent = "Cargando comentarios...";
        
        let fechaISO = new Date(fechaGlobal).toISOString().split('T')[0];
        fetch("/AppCrud/obtener_comentarios/", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
            body: JSON.stringify({
                registro_id: registroIdGlobal,
                fecha: fechaISO,
                servidor_id: servidorIdGlobal,
                empresa_id: empresaIdGlobal
            })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                const listaComentarios = document.getElementById("listaComentarios");
                if (data.comentarios && data.comentarios.trim()) {
                    listaComentarios.textContent = data.comentarios;
                } else {
                    listaComentarios.textContent = "No hay comentarios anteriores.";
                }
            } else {
                document.getElementById("listaComentarios").textContent = "Error al cargar comentarios.";
            }
        }).catch(error => {
            document.getElementById("listaComentarios").textContent = "Error de conexi√≥n al cargar comentarios.";
        });
    }

    function actualizarBotonComentarioEnTabla() {
        // Encontrar el bot√≥n de comentario correspondiente en la tabla
        const botones = document.querySelectorAll('.descripcion-btn');
        
        botones.forEach(boton => {
            // Verificar si es el bot√≥n correcto comparando los atributos data
            const registroId = boton.getAttribute('data-registro-id');
            const fecha = boton.getAttribute('data-fecha');
            const servidorId = boton.getAttribute('data-servidor-id');
            const empresaId = boton.getAttribute('data-empresa-id');
            
            if (registroId == registroIdGlobal && 
                fecha == fechaGlobal && 
                servidorId == servidorIdGlobal && 
                empresaId == empresaIdGlobal) {
                // Agregar la clase azul si no la tiene
                if (!boton.classList.contains('descripcion-btn-azul')) {
                    boton.classList.add('descripcion-btn-azul');
                }
            }
        });
    }

    function cerrarModal() {
        document.getElementById("descripcionText").value = "";
        document.body.classList.remove('modal-open');
        modal.style.display = "none";
    }

    function guardarDescripcion() {
        {% if not usuario_puede_editar %}
            alert("No tiene permisos para modificar las descripciones.");
            return;
        {% endif %}
        
        let descripcion = document.getElementById("descripcionText").value.trim();
        if (!descripcion) {
            alert("Por favor, escriba un comentario antes de guardar.");
            return;
        }
        
        // Mostrar spinner de carga
        mostrarSpinner();
        
        // Guardar la posici√≥n de scroll antes de hacer la petici√≥n
        guardarPosicionScroll();
        
        let fechaISO = new Date(fechaGlobal).toISOString().split('T')[0];
        fetch("/AppCrud/registrarDescripcion/", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
            body: JSON.stringify({
                registro_id: registroIdGlobal,
                fecha: fechaISO,
                descripcion: descripcion,
                servidor_id: servidorIdGlobal,
                empresa_id: empresaIdGlobal
            })
        }).then(response => response.json()).then(data => {
            if (data.success) {
                alert("Comentario agregado correctamente.");
                // Limpiar el campo de nuevo comentario
                document.getElementById("descripcionText").value = "";
                // Recargar los comentarios para mostrar el nuevo
                cargarComentariosExistentes();
                // Actualizar el bot√≥n en la tabla para que se vea azul
                actualizarBotonComentarioEnTabla();
                // No cerrar el modal para permitir agregar m√°s comentarios
                // cerrarModal();
                // location.reload();
                ocultarSpinner();
            } else {
                ocultarSpinner();
                alert("Error al guardar el comentario: " + (data.error || "Error desconocido"));
            }
        }).catch(error => {
            ocultarSpinner();
            alert("Error de conexi√≥n al guardar el comentario.");
        });
    }

    function mostrarComentarioSoloLectura(descripcion) {
        // Esta funci√≥n ya no es necesaria, pero la dejamos para compatibilidad
        return;
    }

    function mostrarTooltip(element) {
        const tooltip = document.getElementById('comentario-tooltip');
        const comentario = element.getAttribute('data-tooltip');
        
        tooltip.textContent = comentario;
        tooltip.style.display = 'block';
        
        // Posicionar el tooltip cerca del elemento
        const rect = element.getBoundingClientRect();
        tooltip.style.left = (rect.left + window.pageXOffset) + 'px';
        tooltip.style.top = (rect.top + window.pageYOffset - tooltip.offsetHeight - 10) + 'px';
        
        // Asegurar que el tooltip no se salga de la pantalla
        const tooltipRect = tooltip.getBoundingClientRect();
        if (tooltipRect.right > window.innerWidth) {
            tooltip.style.left = (window.innerWidth - tooltipRect.width - 10) + 'px';
        }
        if (tooltipRect.left < 0) {
            tooltip.style.left = '10px';
        }
        if (tooltipRect.top < 0) {
            tooltip.style.top = (rect.bottom + window.pageYOffset + 10) + 'px';
        }
    }

    function ocultarTooltip() {
        const tooltip = document.getElementById('comentario-tooltip');
        tooltip.style.display = 'none';
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                let trimmed = cookie.trim();
                if (trimmed.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
                }
            });
        }
        return cookieValue;
    }

    // Funciones para manejar la posici√≥n de scroll
    function guardarPosicionScroll() {
        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) {
            sessionStorage.setItem('scrollTop', tableContainer.scrollTop);
            sessionStorage.setItem('scrollLeft', tableContainer.scrollLeft);
        } else {
            sessionStorage.setItem('scrollTop', window.pageYOffset || document.documentElement.scrollTop);
            sessionStorage.setItem('scrollLeft', window.pageXOffset || document.documentElement.scrollLeft);
        }
    }

    function restaurarPosicionScroll() {
        const scrollTop = sessionStorage.getItem('scrollTop');
        const scrollLeft = sessionStorage.getItem('scrollLeft');
        
        if (scrollTop !== null || scrollLeft !== null) {
            setTimeout(() => {
                const tableContainer = document.querySelector('.table-responsive');
                if (tableContainer) {
                    if (scrollTop !== null) tableContainer.scrollTop = parseInt(scrollTop);
                    if (scrollLeft !== null) tableContainer.scrollLeft = parseInt(scrollLeft);
                } else {
                    if (scrollTop !== null) window.scrollTo(parseInt(scrollLeft) || 0, parseInt(scrollTop));
                }
                // Limpiar despu√©s de restaurar
                sessionStorage.removeItem('scrollTop');
                sessionStorage.removeItem('scrollLeft');
            }, 100);
        }
    }

    // Funciones para manejar el spinner de carga
    function mostrarSpinner() {
        document.getElementById('loadingSpinner').style.display = 'flex';
    }

    function ocultarSpinner() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    // Restaurar la posici√≥n al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        restaurarPosicionScroll();
        
        // Inicializar los √≠ndices originales de los selects
        document.querySelectorAll('.estado-select').forEach(function(select) {
            select.setAttribute('data-original-index', select.selectedIndex);
        });
        
        mostrarSpinner();
        setTimeout(function() {
            ocultarSpinner();
        }, 500); // Esperar 1 segundo antes de ocultar el spinner
    });
</script>

<style>

    a{
        text-decoration-line: none !important;
    }
    
    label, span, h1, h2, h3, h4, h5, h6 {
        color: {{ empresa.visual_empresa.colorPrimario }} !important;
    }

    /* Estilos para los botones de navegaci√≥n de mes */
    .btn-mes-navegacion {
        background-color: {{ empresa.visual_empresa.colorPrimario }} !important;
        border-color: {{ empresa.visual_empresa.colorPrimario }} !important;
        color: {{ empresa.visual_empresa.colorSecundario }} !important;
        border: 1px solid;
        padding: 8px 12px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 500;
        margin: 0 10px;
    }

    .btn-mes-navegacion:hover {
        background-color: {{ empresa.visual_empresa.colorPrimario }} !important;
        border-color: {{ empresa.visual_empresa.colorPrimario }} !important;
        color: {{ empresa.visual_empresa.colorSecundario }} !important;
        opacity: 0.8;
    }

    .btn-mes-navegacion a{
        color: {{ empresa.visual_empresa.colorSecundario }} !important;
        text-decoration: none;
        display: block;
    }

    .btn-mes-navegacion a:hover {
        color: {{ empresa.visual_empresa.colorSecundario }} !important;
        text-decoration: none;
    }
    
    /* Estilos para botones solo con iconos */
    .btn-icon-only {
        padding: 10px 12px !important;
        min-width: 45px;
        text-align: center;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* Estilos para bot√≥n de comentario deshabilitado */
    .descripcion-btn-deshabilitado {
        opacity: 0.5;
        cursor: not-allowed !important;
        background-color: #6c757d !important;
        border-color: #6c757d !important;
    }

    .descripcion-btn-deshabilitado:hover {
        opacity: 0.5 !important;
        background-color: #6c757d !important;
        border-color: #6c757d !important;
    }

    /* Estilos para el tooltip de comentarios */
    .tooltip-comentario {
        position: absolute;
        background-color: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
        z-index: 10002;
        display: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        pointer-events: none;
    }

    .tooltip-comentario::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }
    
    /* Estilos para tabla con header fijo - Monitoreo */
    .table-responsive {
        max-height: 90vh; /* Altura m√°xima del contenedor */
        overflow: auto; /* Permitir scroll horizontal y vertical */
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        position: relative;
    }

    .table-responsive table {
        margin-bottom: 0;
        min-width: 900px;
        border-collapse: separate;
        border-spacing: 0;
    }

    .table-responsive thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa !important;
        z-index: 10;
        border-bottom: 2px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        white-space: nowrap;
        font-weight: bold;
    }

    /* Asegurar que la primera columna tambi√©n sea visible */
    .table-responsive th.nombre-descripcion,
    .table-responsive td.nombre-descripcion {
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 5;
        border-right: 2px solid #dee2e6;
        min-width: 300px;
        max-width: 250px;
        box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
        word-wrap: break-word;
        white-space: normal;
        padding: 12px;
    }

    /* Para el header de la primera columna, necesita mayor z-index */
    .table-responsive thead th.nombre-descripcion {
        z-index: 15;
        background-color: #f8f9fa !important;
    }

    /* Cuando el modal est√° abierto, reducir z-index de elementos sticky */
    .modal-open .table-responsive th.nombre-descripcion,
    .modal-open .table-responsive td.nombre-descripcion,
    .modal-open .table-responsive thead th {
        z-index: 1 !important;
    }

    /* Mejorar el estilo de las celdas */
    .table-responsive td {
        vertical-align: middle;
        padding: 8px;
        border: 1px solid #dee2e6;
        background-color: #fff;
    }    /* Indicador visual de scroll */
    .table-responsive::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 5px;
        background: linear-gradient(to right, transparent, rgba(0,0,0,0.1));
        pointer-events: none;
    }

    /* Estilos para el spinner de carga */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Estilos para el modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 60%;
        max-width: 800px;
        min-width: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        position: relative;
        z-index: 10001;
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Estilos para el √°rea de comentarios existentes */
    #comentariosExistentes {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
        max-height: 200px; /* Limitar la altura m√°xima */
        overflow-y: auto; /* Habilitar scroll vertical */
    }

    #comentariosExistentes h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #333;
        font-size: 1.1em;
    }

    #listaComentarios {
        white-space: pre-line;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.4;
        color: #555;
        background-color: #fff;
        padding: 10px;
        border-radius: 3px;
        border: 1px solid #e0e0e0;
        max-height: 100px; /* Limitar la altura m√°xima del √°rea de comentarios */
        overflow-y: auto; /* Habilitar scroll vertical */
    }

    /* Mejorar el estilo del textarea */
    #descripcionText {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 1em;
        resize: vertical;
    }

    #descripcionText:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }

    .spinner-container {
        text-align: center;
        color: white;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid {{ empresa.visual_empresa.colorPrimario }};
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .spinner-container p {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
    }

    /* Estilos para el select de estados */
    .estado-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .estado-select {
        width: 100%;
        max-width: 90px;
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: white;
        font-size: 12px;
        cursor: pointer;
        text-align: center;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 16px;
        padding-right: 30px;
    }

    .estado-select:focus {
        border-color: {{ empresa.visual_empresa.colorPrimario }};
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .estado-select option {
        padding: 8px;
        font-size: 12px;
    }

    /* Responsive para el select */
    @media (max-width: 768px) {
        .estado-select {
            max-width: 120px;
            font-size: 11px;
        }
    }
</style>
{% endblock %}